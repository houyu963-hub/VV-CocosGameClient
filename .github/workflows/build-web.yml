name: Cocos Web CI/CD

permissions:
  contents: write
  
on:
  # 推送 main / test 分支自动触发
  push:
    branches:
      - main
      - test

  # 手动触发（支持选环境、选分支或 commit）
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        type: choice
        options:
          - test
          - production
      ref:
        description: 'Branch or commit hash'
        required: true
        default: main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      CREATOR_VERSION: 3.8.1
      BUILD_PLATFORM: web-mobile
      BUILD_PATH: build/web-mobile
      CREATOR_DIR: C:\cocos

    steps:
      # 1. 拉代码
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      # 2. Node（Creator 3.8 推荐 Node 16）
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 16

      # 3. npm 缓存
      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}

      # 4. 安装 npm 依赖
      - name: Install dependencies
        run: npm install

      # 5. 缓存 Cocos Creator
      - name: Cache Cocos Creator
        id: cache-creator
        uses: actions/cache@v4
        with:
          path: ${{ env.CREATOR_DIR }}
          key: cocos-creator-${{ env.CREATOR_VERSION }}

      # 6. 下载 Creator（Windows 官方包）
      - name: Download Cocos Creator
        if: steps.cache-creator.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path $env:CREATOR_DIR
          $url = "https://download.cocos.org/CocosCreator/v${env:CREATOR_VERSION}/CocosCreator-v${env:CREATOR_VERSION}-win-092506.zip"
          Write-Host "Downloading: $url"
          Invoke-WebRequest -Uri $url -OutFile creator.zip
          Expand-Archive creator.zip -DestinationPath $env:CREATOR_DIR

      # 7. 计算发布环境
      - name: Resolve Environment
        shell: powershell
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $env:ENV="${{ github.event.inputs.environment }}"
          } elseif ("${{ github.ref }}" -eq "refs/heads/test") {
            $env:ENV="test"
          } else {
            $env:ENV="production"
          }
          Add-Content $env:GITHUB_ENV "ENV=$env:ENV"

      # 8. 生成版本 & changelog
      - name: Generate build info
        shell: powershell
        run: |
          $version = git describe --tags --always
          $time = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          $commit = git rev-parse --short HEAD
          $message = git log -1 --pretty=%B
          $author = git log -1 --pretty=%an

          @"
          {
            "version": "$version",
            "env": "$env:ENV",
            "commit": "$commit",
            "author": "$author",
            "message": "$message",
            "time": "$time"
          }
          "@ | Out-File assets/build-info.json -Encoding utf8

      # 9. Web-Mobile 构建（Windows Creator CLI）
      - name: Build Web-Mobile
        shell: powershell
        run: |
          $exe = Get-ChildItem $env:CREATOR_DIR -Recurse -Filter CocosCreator.exe | Select-Object -First 1
          if (-not $exe) {
            Write-Error "CocosCreator.exe not found"
            exit 1
          }
          Write-Host ("Using Creator: " + $exe.FullName)
          & $exe.FullName `
            --project "$PWD" `
            --build "platform=$env:BUILD_PLATFORM;configPath=build-config/buildConfig_web-mobile.json;mode=release"

      # 10. 发布到 GitHub Pages
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.BUILD_PATH }}
          destination_dir: ${{ env.ENV }}
