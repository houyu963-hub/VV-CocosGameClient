name: Cocos Web CI/CD

on:
  push:
    branches:
      - main
      - test

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        type: choice
        options:
          - test
          - production
      ref:
        description: 'Branch or commit hash'
        required: true
        default: main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      CREATOR_VERSION: 3.8.1
      BUILD_PLATFORM: web-mobile
      BUILD_PATH: build/web-mobile

    steps:
      # 1. 拉代码（支持分支 / commit）
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      # 2. Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3. npm cache
      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
    
      # 4. 缓存 Cocos Creator 编辑器
      - name: Cache Cocos Creator
      id: cache-creator
      uses: actions/cache@v4
      with:
        path: ~/cocos
        key: cocos-creator-${{ env.CREATOR_VERSION }}

      # 5. 下载并解压 Creator（只在没缓存时）
      - name: Download Cocos Creator
          if: steps.cache-creator.outputs.cache-hit != 'true'
          run: |
            mkdir -p ~/cocos
            wget -q https://download.cocos.com/CocosCreator/v${CREATOR_VERSION}/CocosCreator-v${CREATOR_VERSION}-linux-x86_64.zip
            unzip -q CocosCreator-v${CREATOR_VERSION}-linux-x86_64.zip -d ~/cocos

       # 6. install
       - name: Install dependencies
          run: npm install

      # 7. 计算环境
      - name: Resolve Environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV=${{ github.event.inputs.environment }}
          elif [ "${{ github.ref }}" = "refs/heads/test" ]; then
            ENV=test
          else
            ENV=production
          fi
          echo "ENV=$ENV" >> $GITHUB_ENV

      # 8. 版本 & changelog
      - name: Generate build info
        run: |
          VERSION=$(node -p "require('./package.json').version")
          TIME=$(date +'%Y-%m-%d %H:%M:%S')
          COMMIT=$(git rev-parse --short HEAD)
          MESSAGE=$(git log -1 --pretty=%B)
          AUTHOR=$(git log -1 --pretty=%an)

          cat <<EOF > assets/build-info.json
          {
            "version": "$VERSION",
            "env": "$ENV",
            "commit": "$COMMIT",
            "author": "$AUTHOR",
            "message": "$MESSAGE",
            "time": "$TIME"
          }
          EOF
      # 9. 构建 Web-Mobile（核心）
      - name: Build Web-Mobile
        run: |
          ~/cocos/CocosCreator/Creator/${CREATOR_VERSION}/CocosCreator \
            --project $(pwd) \
            --build "platform=${BUILD_PLATFORM};configPath=build-config/buildConfig_web-mobile.json;mode=release"

      # 10. deploy
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web-mobile
          destination_dir: ${{ env.ENV }}
