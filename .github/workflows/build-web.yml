name: Cocos Web CI/CD

permissions:
  contents: write

on:
  push:
    branches: [ main, test ]

  workflow_dispatch:
    inputs:
      environment:
        description: Deploy environment
        required: true
        type: choice
        options: [ test, production ]
      ref:
        description: Branch or commit
        required: true
        default: main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      BUILD_PLATFORM: web-mobile
      BUILD_PATH: build/web-mobile/web-mobile

    steps:
      # 1️⃣ Checkout
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      # 2️⃣ Node（Creator 3.8 推荐）
      - uses: actions/setup-node@v4
        with:
          node-version: 16
          cache: npm

      # 3️⃣ 安装依赖（这里已经包含 cocos CLI）
      - name: Install dependencies
        run: npm install

      # 4️⃣ 环境判定
      - name: Resolve Environment
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" = "refs/heads/test" ]; then
            echo "ENV=test" >> $GITHUB_ENV
          else
            echo "ENV=production" >> $GITHUB_ENV
          fi

      # 5️⃣ 生成 build-info.json（保证一定存在）
      - name: Generate build info
        shell: bash
        run: |
          mkdir -p assets
          cat > assets/build-info.json <<EOF
          {
            "version": "$(git describe --tags --always)",
            "env": "${ENV}",
            "commit": "$(git rev-parse --short HEAD)",
            "author": "$(git log -1 --pretty=%an)",
            "message": "$(git log -1 --pretty=%B | tr '\n' ' ')",
            "time": "$(date '+%Y-%m-%d %H:%M:%S')"
          }
          EOF

      # 6️⃣ Web 构建（核心）
      - name: Build Web-Mobile
        shell: bash
        run: |
          npx cocos build \
            -p web-mobile \
            --mode release \
            --configPath build-config/buildConfig_web-mobile.json

      # 7️⃣ 校验构建结果
      - name: Verify output
        shell: bash
        run: |
          test -d "${BUILD_PATH}" || (echo "❌ build output missing" && exit 1)
          ls -la "${BUILD_PATH}"

      # 8️⃣ Deploy
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.BUILD_PATH }}
          destination_dir: ${{ env.ENV }}
          publish_branch: gh-pages
          enable_jekyll: false
