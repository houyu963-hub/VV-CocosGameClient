name: Cocos Web CI/CD

permissions:
  contents: write

on:
  # 推送 main / test 分支自动触发
  push:
    branches:
      - main
      - test

  # 手动触发（支持选环境、选分支或 commit）
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        type: choice
        options:
          - test
          - production
      ref:
        description: 'Branch or commit hash'
        required: true
        default: main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      BUILD_PLATFORM: web-mobile
      BUILD_PATH: build/web-mobile/web-mobile

    steps:
      # 1. 拉代码
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      # 2. Node（Creator 3.8.x 必须 Node 16）
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 16
          cache: 'npm'

      # 3. 安装 npm 依赖
      - name: Install dependencies
        run: npm install

      # 4. 计算发布环境
      - name: Resolve Environment
        shell: powershell
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $env:ENV="${{ github.event.inputs.environment }}"
          } elseif ("${{ github.ref }}" -eq "refs/heads/test") {
            $env:ENV="test"
          } else {
            $env:ENV="production"
          }
          Add-Content $env:GITHUB_ENV "ENV=$env:ENV"

      # 5. 生成版本 & changelog（写入源码资源）
      - name: Generate build info
        shell: powershell
        run: |
          $version = git describe --tags --always
          $time = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          $commit = git rev-parse --short HEAD
          $message = git log -1 --pretty=%B
          $author = git log -1 --pretty=%an

          @"
          {
            "version": "$version",
            "env": "$env:ENV",
            "commit": "$commit",
            "author": "$author",
            "message": "$message",
            "time": "$time"
          }
          "@ | Out-File assets/build-info.json -Encoding utf8

      # 6. Web-Mobile 构建（✅ 官方 CLI，CI 正解）
      - name: Build Web-Mobile (CLI)
        shell: bash
        run: |
          npx cocos build \
            -p web-mobile \
            --mode release \
            --configPath build-config/buildConfig_web-mobile.json

      # 7. 构建产物校验（防止“假成功”）
      - name: Verify build output
        shell: bash
        run: |
          echo "==== build output ===="
          ls -R build || exit 1
          if [ ! -f "${BUILD_PATH}/index.html" ]; then
            echo "❌ index.html not found in ${BUILD_PATH}"
            exit 1
          fi

      # 8. 发布到 GitHub Pages
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.BUILD_PATH }}
          destination_dir: ${{ env.ENV }}